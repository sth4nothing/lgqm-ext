<script>
// ==UserScript==
// @name         南海农庄助手
// @namespace    http://tampermonkey.net/
// @version      0.2
// @description  一键收获、播种
// @author       You
// @match        https://www.lgqm.top/plugin.php?id=gfarm:front
// @grant        none
// ==/UserScript==

(function () {
    'use strict';

    // Your code here...
    function waitElementAppear(selector, fn, queryInterval = 500, waitOnce = true) {
        var e = document.querySelector(selector)
        if (e) {
            console.log('找到元素', e)
            fn(e)
        }
        if (!e || !waitOnce) {
            setTimeout(() => waitElementAppear(selector, fn, queryInterval, waitOnce), queryInterval)
        }

    }

    function queryLands(canHarvest = false) {
        var lands = []
        for (var i = 1; i <= 40; i++) {
            var e = document.querySelector('span[id="' + i + '"]')
            var e2 = document.querySelector('span#_' + i + '>img.cropimg')
            if (e !== null && e.querySelector('img.jiesuoimg') == null) {
                if (!canHarvest || e2 !== null) {
                    lands.push(i)
                }
            }
        }
        return lands
    }

    function do_sowing() {
        var lands = queryLands()
        var li_id = document.querySelector('#menudiv>ul.line>li').id
        if (li_id == null || !li_id.startsWith('depot_')) {
            setTimeout(do_sowing, 500)
            return
        }
        var depotid = li_id.split('_')[1]
        jQuery('div#closemenu').click()
        for (var id of lands) {
            ajaxget('/plugin.php?id=gfarm:front&mod=gfarm_ajax&depotid=' + depotid + '&formhash=' +
                formhash.value + '&act=germajax&landid=' + id, '')
        }
    }

    function sowing() {
        if (jQuery('div#itemsul').css('display') != 'none') {
            jQuery('div#closemenu').click()
        }
        ajaxget('/plugin.php?id=gfarm:front&mod=gfarm_ajax&do=9', 'itemsul')
        waitElementAppear('div#itemsul[style=""]', function () {
            waitElementAppear('#menudiv>ul.line>li', do_sowing)
        })
    }

    function harvest() {
        var lands = queryLands(true)
        for (var id of lands) {
            ajaxget('https://www.lgqm.top/plugin.php?id=gfarm:front&mod=gfarm_ajax&formhash=' + formhash.value +
                '&act=getcrop&landid=' + id, '')
        }
    }

    window.onload = function () {
        waitElementAppear('div#usermenu', function () {
            jQuery('div#usermenu').append(
                '<span id="sowing"><img src="/source/plugin/gfarm/img/ui/setgerm.png"/><font>全部种植</font></span>'
            )
            jQuery('div#usermenu').append(
                '<span id="harvest"><img src="/source/plugin/gfarm/img/ui/hand.png"/><font>全部收获</font></span>'
            )
            jQuery('div#usermenu>span#sowing').click(sowing)
            jQuery('div#usermenu>span#harvest').click(harvest)
            jQuery('#usermenu>span').css('width', '80px')
        })
    }
})();
</script>
<script>
// 施肥
jQuery('div#closemenu').click()
jQuery('#itemsul').html('')
ajaxget('plugin.php?id=gfarm:front&mod=gfarm_ajax&do=19', 'itemsul')
waitElementAppear('#menudiv>ul.line>li', function () {
    var id = document.querySelector('#menudiv>ul.line>li:nth-child(1)').id.substr(6)
    for (var i = 1; i <= 40; i++) {
        if (document.querySelector('span#_' + i + '>img.cropimg') !== null) {
            ajaxget('/plugin.php?id=gfarm:front&mod=gfarm_ajax&depotid=' + id + '&formhash=' + formhash
                .value + '&act=itemajax&landid=' + i + '&uid=' + userid.value, '')
        }
    }
    setTimeout(() => {
        jQuery('div#closemenu').click()
    }, 2000)
})
</script>
<script>
// 购买接口
jQuery.post('plugin.php?id=gfarm:front&mod=shop&act=buy&formhash=' + formhash.value, {
    goodid: 63,
    do: 9,
    dnum: 19
})
// 种植
var lands = queryLands()
var depotid = '106038'
for (var id of lands) {
    ajaxget('plugin.php?id=gfarm:front&mod=gfarm_ajax&depotid=' + depotid + '&formhash=' +
        formhash.value + '&act=germajax&landid=' + id, '')
}
</script>
<script>
// 偷菜
function getRndInteger(min, max) {
    return Math.floor(Math.random() * (max - min)) + min;
}
for (var i = 1; i <= 40; i++) {
    var e = document.querySelector('div#title_' + i)
    if (e !== null && e.innerText.indexOf('成熟') >= 0) {
        (() => {
            var j = i;
            setTimeout(() => {
                ajaxget('plugin.php?id=gfarm:front&mod=gfarm_ajax&formhash=' + formhash.value +
                    '&uid=' + userid.value + '&act=stealcrop&landid=' + j, '')
            }, getRndInteger(50, 2000))
        })();
    }
}
</script>
<script>
// 显示解锁按钮
for (var i = 1; i <= 40; i++) {
    var e = document.querySelector('span[id="' + i + '"]>img.jiesuoimg')
    if (e !== null) {
        jQuery(e).show()
    }
}
</script>
<script>
// 兑出界面
ajaxget('plugin.php?id=gfarm:front&mod=exchange&act=out&infloat=yes&handlekey=gfarm', 'fwin_content_gfarm')
// 兑出接口
jQuery.post('plugin.php?id=gfarm:front&mod=exchange&act=out', {
    formhash: formhash.value,
    dnum: 101
}, function (data, status, xhr) {
    console.log(data)
})
</script>
<script>
// 农场自动收货
if (jQuery('div#itemsul').css('display') != 'none') {
    jQuery('div#closemenu').click()
}
if (jQuery('div#itemsul').html().trim()) {
    jQuery('div#itemsul').html('')
}
ajaxget('plugin.php?id=gfarm:front&mod=gfarm_ajax&do=9', 'itemsul')
waitElementAppear('div#itemsul>div#menudiv>ul.line>li', () => {
    var funcs = []
    var depotid = document.querySelector('#menudiv>ul.line>li').id.split('_')[1]
    funcs.push((id) => {
        ajaxget('plugin.php?id=gfarm:front&mod=gfarm_ajax&depotid=' + depotid + '&formhash=' +
            formhash.value + '&act=germajax&landid=' + id, '', () => funcs[1](id))
    }, (id) => {
        ajaxget('plugin.php?id=gfarm:front&mod=gfarm_ajax&formhash=' + formhash.value +
            '&act=getcrop&landid=' + id, '', () => funcs[0](id))
    })
    for (var id = 1; id <= 40; id++) {
        var e = document.querySelector('span[id="' + id + '"]')
        var e2 = document.querySelector('span#_' + id + '>img.cropimg')
        if (e !== null && e.querySelector('img.jiesuoimg') == null) {
            funcs[e2 == null ? 0 : 1](id)
        }
    }
})
</script>
<script>
// 自动访问个人主页
var uids = [23, 26, 31, 37, 286, 368, 423, 523, 595, 2539]
var ff = document.createElement('div')
var iframe = document.createElement('iframe')
iframe.style.width = '100%'
iframe.style.height = '480px'
ff.id = 'ff'
ff.appendChild(iframe)
var wp = document.getElementById('wp')
wp.insertBefore(ff, wp.firstElementChild)

function visit() {
    if (uids.length == 0) return
    var uid = uids.pop()
    iframe.src = '/?' + uid
    if (iframe.onload === null) {
        iframe.onload = visit
    }
}
visit()
</script>
